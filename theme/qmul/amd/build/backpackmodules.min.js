define(["jquery","core/templates","core/log"],function(a,b,c){return{init:function(){c.debug("QMUL Backpack Modules JavaScript initialised");var b=this;a(document).ready(function(){a("body").on("click",".backpack .modules .module .pincourse",function(c){if(c.preventDefault(),a(this).hasClass("disabled"))return!1;a(this).addClass("disabled");var d=a(this).parent(".module"),e=d.data("courseid"),f=d.data("state"),g=d.data("userid"),h=a(this);a.ajax({url:M.cfg.wwwroot+"/theme/qmul/lib/pincourse.php",context:document.body,data:{courseid:e,state:f,userid:g},method:"GET"}).done(function(a){1==a.success&&(b.process_pinned_course(d,e,a.newpreference),h.toggleClass("pinned"),d.toggleClass("pinned"),"1"==a.newpreference?d.data("state",1):d.data("state",0),h.removeClass("disabled"))}).fail(function(a,b,c){})}),a("body").on("click",".backpack .allmodules a.loadmore",function(b){if(a(this).hasClass("disabled"))return!1;a(this).addClass("disabled");var c=a(this).data("userid"),d=a(this).data("currentloaded"),e=a(this);a(this).append('<i class="glyphicon glyphicon-refresh spin"></i>'),a.ajax({url:M.cfg.wwwroot+"/theme/qmul/lib/loadmorecourses.php",context:document.body,data:{userid:c,currentloaded:d},method:"GET"}).done(function(a){e.before(a.html),0==a.loadmore?e.remove():(e.data("currentloaded",d+10),e.removeClass("disabled"),e.find("i").remove())}).fail(function(a,b,c){})}),a("body").on("click",".backpack .modules .modulebox .pincourse",function(c){if(c.preventDefault(),a(this).hasClass("disabled"))return!1;a(this).addClass("disabled");var d=a(this).parent(".modulebox"),e=d.data("courseid"),f=d.data("state"),g=d.data("userid"),h=a(".backpack .allmodules .module[data-courseid="+e+"]");a.ajax({url:M.cfg.wwwroot+"/theme/qmul/lib/pincourse.php",context:document.body,data:{courseid:e,state:f,userid:g},method:"GET"}).done(function(a){1==a.success&&(b.process_pinned_course(d,e,a.newpreference),h.toggleClass("pinned"),d=h.parent(".module"),d.toggleClass("pinned"),"1"==a.newpreference?d.data("state",1):d.data("state",0),h.removeClass("disabled"))}).fail(function(a,b,c){})}),a("body").on("click",".qmultabitem.pincoursetab .pincourse",function(b){if(b.preventDefault(),a(this).hasClass("disabled"))return!1;a(this).addClass("disabled");var c=a(this).data("courseid"),d=a(this).data("state"),e=a(this).data("userid"),f=a(this);a.ajax({url:M.cfg.wwwroot+"/theme/qmul/lib/pincourse.php",context:document.body,data:{courseid:c,state:d,userid:e},method:"GET"}).done(function(a){1==a.success&&(f.toggleClass("pinned"),"1"==a.newpreference?(f.data("state",1),f.attr("title",M.util.get_string("unpinthismodule","theme_qmul")),f.attr("original-title",M.util.get_string("unpinthismodule","theme_qmul")),f.attr("data-original-title",M.util.get_string("unpinthismodule","theme_qmul"))):(f.data("state",0),f.attr("title",M.util.get_string("pinthismodule","theme_qmul")),f.attr("original-title",M.util.get_string("pinthismodule","theme_qmul")),f.attr("data-original-title",M.util.get_string("pinthismodule","theme_qmul"))),f.removeClass("disabled"))}).fail(function(a,b,c){})})})},process_pinned_course:function(c,d,e){if(0==e)a(".pinnedmodules .modulebox[data-courseid="+d+"]").remove();else{var f=c.data("name"),g=c.data("categoryname"),h=c.data("warning"),i=c.data("invisible"),j=c.data("userid"),k=c.data("url"),l=c.data("overviewfile"),m={id:d,userid:j,fullname:f,categoryname:g,warning:h,invisible:i,url:k,overviewfile:l};a(".pinnedmodules .nopins").length>0&&a(".pinnedmodules .nopins").remove(),a(".pinnedmodules .modulebox[data-courseid="+d+"]").length>0&&a(".pinnedmodules .modulebox[data-courseid="+d+"]").remove();b.render("theme_qmul/pinnedmodule",m).done(function(c,d){b.appendNodeContents(a(".backpack .pinnedmodules"),c,d)})}}}});