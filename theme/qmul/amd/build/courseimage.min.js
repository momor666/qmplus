define(["jquery","core/log","core/ajax","core/notification"],function(a,b,c,d){return{addcourseimageAlert:function(b,c){var d=M.util.get_string("close","theme_qmul");a(b).length||a("#courseimagecontrol").after('<div id="'+b+'" class="alert alert-warning" role="alert">'+c+'<button type="button" class="close" data-dismiss="alert" aria-label="'+d+'"><span aria-hidden="true">&times;</span></button></div>')},humanFileSize:function(a){var b=Math.floor(Math.log(a)/Math.log(1024));return 1*(a/Math.pow(1024,b)).toFixed(2)+" "+["B","kB","MB","GB","TB"][b]},init:function(b,c){var d=this,e=b.shortname;a(".path-course-view .courseheader").data("servercoverfile",a(".path-course-view .courseheader").css("background-image"));var f,g;a("#changecourseimage").click(function(b){b.preventDefault(),a(this).removeClass("state-visible"),a('label[for="coverfiles"]').addClass("state-visible")});var h=function(){a("#alert-cover-image-size").remove(),a("#alert-cover-image-bytes").remove(),a('label[for="coverfiles"] .loadingstat').remove(),a("#changecourseimageconfirmation").removeClass("state-visible"),a('label[for="coverfiles"]').addClass("state-visible"),a("#coverfiles").val("")},i=function(){a("#changecourseimageconfirmation").removeClass("disabled"),a('label[for="coverfiles"]').removeClass("state-visible"),a("#changecourseimageconfirmation").addClass("state-visible"),a("body").removeClass("cover-image-change")};a("#coverfiles").on("change",function(b){a("body").addClass("cover-image-change");var e=b.target.files;if(e.length&&(f=e[0],f.type.match("image.*"))){var j=new FileReader;a('label[for="coverfiles"]').append('<span class="loadingstat spinner-three-quarters">'+M.util.get_string("loading","theme_qmul")+"</span>"),j.onload=function(b){return function(e){g=e.target.result,a(".path-course-view .courseheader").addClass("hasimage");var f=a("<img />");f=f.get(0),f.src=g,f.width<1024?d.addcourseimageAlert("alert-cover-image-size",M.util.get_string("error:courseimageresolutionlow","theme_qmul")):a("#alert-cover-image-size").remove();var j=c;if(b.size>j){h();var k=humanFileSize(j),l=M.util.get_string("error:courseimageexceedsmaxbytes","theme_qmul",k);return void d.addcourseimageAlert("alert-cover-image-bytes",l)}a("#alert-cover-image-bytes").remove(),a(".path-course-view .courseheader").css("background-image","url("+g+")"),a(".path-course-view .courseheader").data("localcoverfile",b.name),i()}}(f),j.readAsDataURL(f)}}),a("#changecourseimageconfirmation .ok").click(function(){if(!a(this).parent().hasClass("disabled")){a("#alert-cover-image-size").remove(),a("#alert-cover-image-bytes").remove(),a("#changecourseimageconfirmation .ok").append('<span class="loadingstat spinner-three-quarters">'+M.util.get_string("loading","theme_qmul")+"</span>"),a("#changecourseimageconfirmation").addClass("disabled");var b=g.split("base64,")[1];a.ajax({url:M.cfg.wwwroot+"/theme/qmul/lib/courseimage.php",context:document.body,contentType:"application/x-www-form-urlencoded",data:{imagefilename:f.name,imagedata:b,courseshortname:e},method:"POST"}).done(function(b){if(h(),a("#changecourseimageconfirmation .ok .loadingstat").remove(),!b.success&&b.warning)return void d.addcourseimageAlert("alert-cover-image-upload-failed",b.warning);a("#alert-cover-image-upload-failed").remove()}).fail(function(b,c,e){a(".path-course-view .courseheader").css("background-image",a(".path-course-view .courseheader").data("servercoverfile")),"none"==a(".path-course-view .courseheader").data("servercoverfile")&&a(".path-course-view .courseheader").removeClass("hasimage"),h(),d.addcourseimageAlert("alert-cover-image-upload-failed",e),a("#changecourseimageconfirmation .ok .loadingstat").remove()})}}),a("#changecourseimageconfirmation .cancel").click(function(){a(this).parent().hasClass("disabled")||(a(".path-course-view .courseheader").css("background-image",a(".path-course-view .courseheader").data("servercoverfile")),"none"==a(".path-course-view .courseheader").data("servercoverfile")&&a(".path-course-view .courseheader").removeClass("hasimage"),h())}),a("#courseimagecontrol").addClass("js-enabled")},showError:function(a){if("object"!=typeof a)try{a=JSON.parse(a)}catch(a){}if(void 0===a&&(a={error:M.util.get_string("unknownerror","core")}),a.error||a.errorcode)if(a.backtrace)d.exception(a);else{var b;a.error?(b=a.error,a.stacktrace&&(b="<div>"+b+"<pre>"+a.stacktrace+"</pre></div>")):b=a.errorcode&&a.message?a.message:M.util.get_string("unknownerror","moodle"),d.alert(M.util.get_string("error","moodle"),b,M.util.get_string("ok","moodle"))}return!1}}});