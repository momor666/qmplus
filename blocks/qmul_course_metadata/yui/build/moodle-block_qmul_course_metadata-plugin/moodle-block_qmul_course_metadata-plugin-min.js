YUI.add("moodle-block_qmul_course_metadata-plugin",function(e,t){M.block_qmul_course_metadata=M.block_qmul_course_metadata||{},M.block_qmul_course_metadata.plugin=M.block_qmul_course_metadata.plugin||{},M.block_qmul_course_metadata.plugin.init=function(t){var n=this;this.sits_data_request=null,this.sits_course_id=null,this.data=t,this.io_complete=e.on("io:complete",this.load_sits_data_complete,e,this),this.dmp=new diff_match_patch,e.all("a.view-link").on("click",function(e){n.update(),n.dialog.show(),e.preventDefault()}),this.dialog=new e.Panel({contentBox:e.Node.create("<div>"),bodyContent:'<div class="message">Click</div>',width:800,zIndex:6,centered:!0,modal:!0,visible:!1,buttons:{footer:[{name:"done",label:"Done",action:"onDone"}]}}),this.dialog.onDone=function(e){e.preventDefault(),this.hide()},this.dialog.render(),e.one("#id_idnumber").on("focus",function(t){n.last_idnumber=e.one(t.target).get("value")},this),e.one("#id_idnumber").on("blur",function(t){var r=e.one(t.target).get("value");n.last_idnumber!=r&&n.load_sits_data(r)},this),setTimeout(function(){if(typeof tinyMCE!="undefined"&&typeof tinyMCE.get("id_summary_editor")!="undefined"){var e=window.parent.tinyMCE.get("id_summary_editor"),t=function(e,t){n.update()};e.onChange.add(t),e.onKeyUp.add(t)}},3e3);var r=["change","input","focus","blur","DOMSubtreeModified","propertychange"];for(var i=0;i<r.length;i++)e.delegate(r[i],function(){n.update()},"body","#id_fullname,#id_shortname,#id_summary_editor,#id_summary_editoreditable,#tinymce, #tinymce p");this.update()},M.block_qmul_course_metadata.plugin.load_sits_data=function(t){t==""&&(this.data=null,this.update()),this.sits_course_id=t,e.io("/local/qmul_sync/ajax.php?action=moodle_course&idnumber="+t)},M.block_qmul_course_metadata.plugin.load_sits_data_complete=function(t,n,r){var i=/^.*\/\/[^\/]*([^\?]*)\??.*$/,s=i.exec(n.responseURL);s[1]=="/local/qmul_sync/ajax.php"&&(s=e.JSON.parse(n.responseText),r.data=s,r.update(),e.one("#id_fullname").get("value")==""&&e.one("#id_fullname").set("value",r.data.sits.course_name),e.one("#id_shortname").get("value")==""&&e.one("#id_shortname").set("value",r.data.sits.course_short_name),e.one("#id_summary_editor").get("text")==""&&(e.one("#id_summary_editor").set("value","<p>"+r.data.sits.module_desc+"</p>"),e.one("#id_summary_editor").simulate("change")),e.one("#id_summary_editoreditable")&&e.one("#id_summary_editoreditable").get("text")==""&&(e.one("#id_summary_editoreditable").setHTML("<p>"+r.data.sits.module_desc+"</p>"),e.one("#id_summary_editoreditable").simulate("change")))},M.block_qmul_course_metadata.plugin.updateable=function(){var e=this.fullname_updateable()||this.shortname_updateable()||this.summary_updateable();return e},M.block_qmul_course_metadata.plugin.fullname_updateable=function(){if(this.data&&this.data.sits){var t=this.data.sits.course_name,n=e.one("#id_fullname").get("value");return t!=n}return!1},M.block_qmul_course_metadata.plugin.shortname_updateable=function(){if(this.data&&this.data.sits){var t=this.data.sits.course_short_name,n=e.one("#id_shortname").get("value");return t!=n}return!1},M.block_qmul_course_metadata.plugin.summary_updateable=function(){if(this.data&&this.data.sits){var t=this.data.sits.module_desc,n,r;if(typeof tinyMCE!="undefined"){if(typeof tinyMCE.get("id_summary_editor")!="undefined"){var i=tinyMCE.get("id_summary_editor");n=i.getContent()}}else(r=e.one("#id_summary_editoreditable"))?n=r.get("text"):n=e.one("#id_summary_editor").get("value");return n==t||n=="<p>"+t+"</p>"?!1:n!=t||n!="<p>"+t+"</p>"}return!1},M.block_qmul_course_metadata.plugin.update=function(){var t=e.one(".block_qmul_course_metadata .content"),n,r=!1;this.data&&this.data.sits?this.updateable()?(n=M.str.block_qmul_course_metadata.sits_diff,r=!0):n=M.str.block_qmul_course_metadata.sits_same:n=M.str.block_qmul_course_metadata.sits_none,t.one(".message").setHTML(n),r?t.one(".view-link").set("style",""):t.one(".view-link").set("style","display: none");var i=e.one("#id_fullname").get("value"),s=e.one("#id_shortname").get("value"),o,u;(u=e.one("#id_summary_editoreditable"))?o=u.get("text"):typeof tinyMCE!="undefined"?typeof tinyMCE.get("id_summary_editor")!="undefined"&&(o=tinyMCE.get("id_summary_editor").getContent()):o=e.one("#id_summary_editor").get("text");var a="";a+=M.str.block_qmul_course_metadata.sits_help,a+='<table class="course-vs-sitsdata">',a+="<tbody>",a+=this.add_data_row("Full Name","course_name",i),a+=this.add_data_row("Short Name","course_short_name",s),a+=this.add_data_row("Description","module_desc",o),a+="</tbody>",a+="<tfoot>",this.updateable()&&(a+='<td/><td/><td><input type="button" value="Copy all changes" class="copy course_name course_short_name module_desc"/></td>'),a+="</tfoot>",a+="</table>",a+=M.str.block_qmul_course_metadata.sits_wrong;if(this.dialog.get("bodyContent")!=a){this.dialog.set("bodyContent",a);var f=this;this.dialog.get("contentBox").all(".copy.course_name").on("click",function(t){e.one("#id_fullname").set("value",f.data.sits.course_name),f.update()}),this.dialog.get("contentBox").all(".copy.course_short_name").on("click",function(t){e.one("#id_shortname").set("value",f.data.sits.course_short_name),f.update()}),this.dialog.get("contentBox").all(".copy.module_desc").on("click",function(t){if(e.one("#id_summary_editoreditable"))e.one("#id_summary_editoreditable").setHTML("<p>"+f.data.sits.module_desc+"</p>"),e.one("#id_summary_editoreditable").simulate("change");else if(typeof tinyMCE!="undefined"){if(tinyMCE.get("id_summary_editor")!=="undefined"){var n=window.parent.tinyMCE.get("id_summary_editor");e.one("#id_summary_editor").set("value",f.data.sits.module_desc),n.setContent("<p>"+f.data.sits.module_desc+"</p>"),e.one("#id_summary_editor").simulate("change")}}else console.log("Error: unidentified editor.");f.update()})}},M.block_qmul_course_metadata.plugin.add_data_row=function(e,t,n){var r=this.data&&this.data.sits?this.data.sits[t]:"",i=r==n;if(n==null||r==null)return;var s=/^<p[^>]*>|<\/p>$/g
;n=n.replace(s,""),r=r.replace(s,"");var o=this.dmp.diff_main(n,r),u="";u+="<tr>",u+='<td class="description">'+e+"</td>",u+="<td>";for(var a=0;a<o.length;a++)switch(o[a][0]){case-1:u+='<span class="removed">'+o[a][1]+"</span>";break;case 0:u+='<span class="unchanged">'+o[a][1]+"</span>";break;case 1:u+='<span class="added">'+o[a][1]+"</span>"}return u+="</td>",i?u+='<td class="button-col">Same as editor</td>':u+='<td class="button-col"><input type="button" value="Copy changes to editor" class="copy '+t+'"/></td>',u+="</tr>",u}},"@VERSION@",{requires:["base","io-base","node","json-parse","panel","yui-lang-later","node","event-valuechange"]});
