define(["jquery","core/ajax","core/notification","core/templates"],function(a,b,c,d){function e(a){var b=a.closest(".block");if(!b.length)return null;var c=b.attr("id");return c=parseInt(c.substring(4),10)}function f(a){return a.closest(".widgets-main").find(".widgets")}function g(a){var b=a.closest(".widgets-main").find(".nowidgets"),c=f(a);c.find(".widgets-widget").length?b.removeClass("show"):b.addClass("show")}function h(a,e,h){var i=b.call([{methodname:"block_widgets_add",args:{blockinstanceid:a,type:e}}]);i[0].done(function(a){a.widget&&d.render("block_widgets/widget",a.widget).then(function(a){f(h).append(a),g(h),h.removeClass("loading").addClass("inuse"),k()})}).fail(c.exception)}function i(a,d,e){var h=b.call([{methodname:"block_widgets_remove",args:{blockinstanceid:a,type:d}}]);h[0].done(function(){f(e).find(".widgettype-"+d).remove(),g(e),e.removeClass("loading").removeClass("inuse"),k()}).fail(c.exception)}function j(b){b.preventDefault();var c=a(b.currentTarget),d=e(c),f=c.data("type");d&&f&&(c.addClass("loading"),c.hasClass("inuse")?i(d,f,c):c.closest(".widgets-availableholder").hasClass("maxreached")||h(d,f,c))}function k(){a(".widgets-main").each(function(b,c){var d=a(c),e=d.find(".widgets-availableholder"),f=d.find(".widgets-widget").length,g=e.find(".widgets-available").length;f>=l&&g>f?e.addClass("maxreached"):e.removeClass("maxreached")})}var l;return{init:function(b){l=b.maxwidgets,k();var c=a("body");c.on("click",".widgets-available",j)}}});