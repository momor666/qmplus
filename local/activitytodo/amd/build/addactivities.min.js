define(["jquery","core/ajax","core/templates","core/notification"],function(a,b,c,d){function e(){a(".activityinstance").each(function(b,c){var d=a(c);if(!f(d)){var e=i(d);if(e){var h=l.indexOf(e)===-1;g(d,h,!0)}}})}function f(a){var b,c=a.closest(".activity");for(b in n)if(n.hasOwnProperty(b)&&c.hasClass(n[b]))return!0;return!1}function g(a,b,e){c.render("local_activitytodo/icon",{isAdd:b}).then(function(b){e?a.prepend(b):a.replaceWith(b)}).fail(d.exception)}function h(){return a(m.loading)}function i(a){var b=a.closest(".activity");if(!b)return null;var c=b.attr("id").split("-");return c.length<2?null:c[1]}function j(a){return a.hasClass("activitytodo-add")}function k(c){c.preventDefault();var e=a(c.currentTarget),f=i(e);if(f){var k=j(e),l=h();e.replaceWith(l),e=l;var m=k?"local_activitytodo_add":"local_activitytodo_remove",n=b.call([{methodname:m,args:{cmid:f}}]);n[0].done(function(){g(e,!k,!1)}).fail(d.exception)}}var l=[],m={},n=[];return{init:function(b){l=b.todolistCmids,m=b.icons,n=b.excludedmods,e(),a("body").on("click",".activitytodo",k)}}});