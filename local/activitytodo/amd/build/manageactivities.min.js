define(["jquery","core/ajax","core/notification","core/modal_factory","core/modal_events","core/templates","jqueryui"],function(a,b,c,d,e,f){function g(d){var e=a(d.target).sortable("toArray",{attribute:"data-cmid"}),f=b.call([{methodname:"local_activitytodo_sort",args:{cmids:e}}]);f[0].fail(c.exception)}function h(a){var b=a.closest(".activitytodo-item");return b.length?b.data("cmid"):null}function i(){return a(u.loading)}function j(a){var b=a.closest(".activitytodo-note");b.length||(b=a.find(".activitytodo-note"));var c=b.data("content");return void 0===c&&(c=b.find(".activitytodo-notecontent").html()),c}function k(a,b){var c=a.closest(".activitytodo-note");c.data("content",b)}function l(a,b){f.render("local_activitytodo/noteicon",{hasnote:b}).then(function(b){a.replaceWith(b)}).fail(c.exception)}function m(f){f.preventDefault();var g=a(f.currentTarget),m=h(g);if(m){var n=j(g);d.create({title:M.util.get_string("updatenote","local_activitytodo"),body:'<textarea name="notecontent" class="activitytodo-editnote">'+n+"</textarea>",type:d.types.SAVE_CANCEL}).done(function(d){var f=d.getRoot();f.on(e.shown,function(){f.find('textarea[name="notecontent"]').focus()}),f.on(e.save,function(){var d=f.find('textarea[name="notecontent"]'),e=a.trim(d.val()),h=i();g.replaceWith(h),g=h;var j=b.call([{methodname:"local_activitytodo_update_note",args:{cmid:m,note:e}}]);j[0].done(function(){l(g,!!e),k(g,e)}).fail(c.exception)}),f.on(e.hidden,function(){d.destroy()}),d.show()})}}function n(a){a=o(a);var b=a.find("input");return b.length?b.val():a.text()}function o(a){return a.closest(".activitytodo-item").find(".activitytodo-showduedate")}function p(a,b){f.render("local_activitytodo/duedateicon",{editduedate:b}).then(function(b){a.closest(".activitytodo-item").find(".activitytodo-editduedate").replaceWith(b)}).fail(c.exception)}function q(b){b.preventDefault();var c,d=a(b.currentTarget),e=o(d),f=e.find("input");f.length?r(e):(c=e.text(),f=a('<input type="text" value="'+c+'">'),e.html(f),e.find("input").datepicker({dateFormat:e.data("format"),onSelect:function(){a(this).focus()}}).keydown(function(b){13===b.which&&(r(e),a("#ui-datepicker-div").css("display","none"))}).focus(),p(d,!0))}function r(a){var c=h(a);if(c){var d=n(a),e=b.call([{methodname:"local_activitytodo_update_duedate",args:{cmid:c,duedate:d}}]);e[0].done(function(b){o(a).html(b.duedate),b.overdue?a.closest(".activitytodo-item").addClass("activitytodo-overdue").addClass("alert-danger"):a.closest(".activitytodo-item").removeClass("activitytodo-overdue").removeClass("alert-danger"),p(a,!1)})}}function s(d){d.preventDefault();var e=a(d.currentTarget),f=h(e);if(f){var g=b.call([{methodname:"local_activitytodo_remove",args:{cmid:f}}]);g[0].done(function(){var a=e.closest(".activitytodo-item"),b=a.find(".activitytodo-activityname").text(),d=j(a).replace(/"/g,"&quot;"),g=n(a),h=M.util.get_string("todoitemremoved","local_activitytodo",b);h+=' <a href="#" class="activitytodo-undoremove" data-cmid="'+f+'" data-note="'+d+'"  data-duedate="'+g+'" >'+M.util.get_string("undo","local_activitytodo")+"</a>",c.addNotification({type:"success",message:h}),a.remove()})}}function t(c){c.preventDefault();var d=a(c.currentTarget),e=d.data("cmid"),f=d.data("note"),g=d.data("duedate"),h=[{methodname:"local_activitytodo_add",args:{cmid:e}}];f&&h.push({methodname:"local_activitytodo_update_note",args:{cmid:e,note:f}}),g&&h.push({methodname:"local_activitytodo_update_duedate",args:{cmid:e,duedate:g}});var i=b.call(h);a.when.apply(a,i).done(function(){window.location.reload(!0)})}var u;return{init:function(b){u=b.icons;var c=a(".activitytodo-items");c.sortable(),c.on("sortupdate",g),c.disableSelection(),c.on("click",".activitytodo-noteicon",m),c.on("click",".activitytodo-editduedate",q),c.on("click",".activitytodo-remove",s),a("body").on("click",".activitytodo-undoremove",t)}}});