define(["jquery","core/log","jqueryui"],function(a,b){"use strict";return b.debug("messageview.js loaded"),{init:function(){a(".clickable-row").click(function(){window.document.location=a(this).data("href")});var b=a(".qmul-message-list-dialog-html").html(),c=a(".dialog-opener"),d=a(".message-dialog");a(".message-dialog").append(b),d.css({height:"500px",overflow:"auto"}).dialog({autoOpen:!1,resizable:!1,height:500,width:400,title:"Messages",dialogClass:"no-close local_qmul_message_dialog",position:{my:"left top",at:"left bottom",of:c},buttons:[{text:"Mark all as read",icons:{primary:"ui-icon-heart"},click:function(){a(this).dialog("close")}},{text:"View all Messages ",icons:{primary:"ui-icon-heart"},click:function(){a(this).dialog("close")}}]}),c.click(function(){d.dialog("isOpen")?d.dialog("close"):d.dialog("open")})},sent_actions:function(c){var d,e;e=a(".delete-action"),d=a(".hide-action");var f=function(d){d.preventDefault(),b.debug("action : "+d.data.action);var e,g,h,i,j;switch(e=a(this),g=e.children("a").attr("data-messageid"),h="/webservice/rest/server.php?",d.data.action){case"delete":j="local_qmul_messaging_delete_message";break;case"hide":j="local_qmul_messaging_hide_message";break;default:j="local_qmul_messaging_hide_message"}i={wstoken:c.token,wsfunction:j,moodlewsrestformat:"json",messageid:g},a.ajax({url:h,data:i}).done(function(a){switch(b.debug(a.feedback),a.action){case"delete":e.parent("tr").remove();break;case"hide":e.parent("tr").find("span.message-status div.text_to_html").text(c.status.hidden),e.parent("tr").find("td.hide-action").unbind("click").find("a").text(c.action["delete"]),e.parent("tr").find("td.hide-action").on("click",null,{action:"delete"},f)}b.debug(c.status.hidden)})};e.on("click",null,{action:"delete"},f),d.on("click",null,{action:"hide"},f),b.debug("You are running jQuery version: "+a.fn.jquery),b.debug(c)},init_feed:function(b){a.ajax({url:b.url,context:a(".local-qmul-messaging-feeditems"),success:function(b){var c=this,d=a(a.parseXML(b));d.find("entry").each(function(){var b=a(this).find("title").text(),d=a(this).find("content").text(),e="<li>";e+='<div class="item title">'+b+"</div>",e+='<div class="item description">'+d+"</div>",a(this).find("link").each(function(){var b=a(this).attr("rel"),c=a(this).text();"edit"==b&&(e+='<a class="edit" href="'+c+'">Edit</a>')}),e+="</li>",a(c).append(e)})}})},message_ticker:function(c){var d,e;if(d=a(".news-ticker").length,b.debug(d),0===d)return!1;var f;f="/webservice/rest/server.php",e={wstoken:c.token,wsfunction:"local_qmul_messaging_get_user_messages_syndicate",moodlewsrestformat:"json",userid:c.user,contextid:c.context},a.ajax({url:f,data:e}).done(function(c){b.debug("message ajax success"),b.debug(c),a.each(c,function(b,c){var d,e,f;return d='<a onclick="this.target=&quot;_blank&quot;"',d+='href="',d+=c.link,d+='" ',d+='data-hasqtip="13"',d+='aria-describedby="qtip-13">',d+=c.title,d+="</a>",e='<div class="link">',e+=d,e+="</div>",f='<div class="list">',f+=e,f+="</div>",a(".news-ticker > div").append(f),3!==b})}).fail(function(){b.debug("message ajax fail")})}}});